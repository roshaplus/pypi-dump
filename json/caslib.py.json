{
  "info": {
    "author": "CyVerse",
    "author_email": "atmodevs@gmail.com",
    "bugtrack_url": "",
    "classifiers": [],
    "description": "CASLIB.PY\r\n=========\r\n\r\nA library to support OAuth, SAML, and CAS Clients as provided from a JASIG-CAS(3.5-4.0.0+) server\r\n\r\nWritten in python using requests\r\n\r\n_Requirements_\r\n- requests\r\n- CAS Server\r\n  - cas-server-support-oauth (Required for OAuth support)\r\n  - cas-server-support-saml (Required for SAML support)\r\n\r\nAUTHOR\r\n======\r\n\r\nSteven Gregory - iPlant Collaborative \u00a9 2012-2014\r\n\r\nCONTACT: sgregory@iplantcollaborative.org\r\n\r\n\r\nPREFACE\r\n-------\r\ncaslib.py was initially built for a specific purpose, to add cas to a pre-existing authentication system (in Django).\r\nThe authentication system used token-based sessions that have a timeout, and the user was required to reauthenticate to renew the token.\r\nAs caslib.py has been developled it has been used as a robust CAS library for multiple projects within the iPlant Collaborative without issues,\r\nwith that being said this implementation is not guaranteed to work for your implementation of CAS.\r\n\r\nThe documentation on CAS is getting better, to learn about any of these protocols, visit: http://jasig.github.io/cas/4.0.0/index.html\r\nCASLIB.PY HISTORY\r\n=================\r\n[1.0] - caslib.py initial development complete\r\n\r\ncaslib.py was initially developed for Atmosphere, an AJAX based web application for iPlant Collaborative.\r\nIn the first iteration of the library it served only two primary functions:\r\n* Validating a ticket after a CAS login (aka BASIC AUTHENTICATION)\r\n* Validating a proxyTicket and it's associated user (aka RE-AUTHENTICATION BY PROXY)\r\n\r\n[2.0] - caslib.py refactored to support multiple 'Client', 'Response' protocols\r\n\r\nIf supported by your CAS Server, caslib.py now includes support for:\r\n* CAS authentication (Basic & through Proxy)\r\n* SAML authentication (Basic ONLY)\r\n* OAUTH 2.0 authentication\r\n\r\nCAS AUTHENTICATION\r\n====================\r\n\r\nOption 1: Basic Authentication\r\n-------\r\n\r\nIf your application requires authenticating the user once, caslib.py is great!\r\n- Redirect your 'login' button/path to the CAS servers login\r\n  Ex: CAS login path\r\n\r\n        CASLoginURL = https://path.to_cas_server.org/cas/login?service=https://path.to/CAS_serviceValidater?sendback=/application/\r\n\r\n  NOTE: The sendback parameter allows you to redirect the authenticated user to the endpoint they selected.  A race condition may occur if multiple users attempt to access multiple endpoints on a website.\r\n- When your app receives a request with a \"ticket\" in the query string, CAS is sending you an authenticated user.\r\n- To validate the ticket:\r\n\r\n  ```python\r\n    cas_client = CASClient(\"https://path.to_cas_server.org\",\r\n                           \"https://path.to_cas_server.org/CAS_serviceValidater?sendback=/application/\",\r\n                           )\r\n    ticket_from_cas = request.GET['ticket']\r\n    cas_response = cas_client.cas_serviceValidate(ticket_from_cas)\r\n    #cas_response object\r\n    (truth, user) = (cas_response.success, cas_response.user)\r\n    if (truth) redirect(user,sendback) else redirect(CASLoginURL)\r\n  ```\r\n\r\nOption 2: Re-Authentication of the user by proxy\r\n-------\r\n\r\n\r\nDJANGO IMPLEMENTATION\r\n------------\r\n\r\ncaslib.py was written to be integrated with the python web framework, Django. Django is not required to use caslib.py. A more detailed description of this can be found at GENERIC USAGE\r\n\r\nBelow is an example of the settings, urls.py, views.py, and models.py that are required for caslib.py to function properly:\r\n\r\n###settings.py###\r\n  ```python\r\n    ##These settings will be used often\r\n    CAS_SERVER = \"https://path.to_cas_server.org\"\r\n    SERVICE_URL = \"https://path.to/CAS_serviceValidater?sendback=/application/\"\r\n    PROXY_URL = \"https://path.to/CAS_proxyUrl\"\r\n    PROXY_CALLBACK_URL = \"https://path.to/CAS_proxyCallback\"\r\n    SELF_SIGNED_CERT = False\r\n  ```\r\n\r\n###models.py###\r\n  ```python\r\n    class UserProxy(models.Model):\r\n      \"\"\"\r\n      This model will be used to Map usernames, initially unknown, to proxy IOU ID ticket pairs\r\n      \"\"\"\r\n      username = models.CharField(max_length=128, blank=True, null=True)\r\n      proxyIOU = models.CharField(max_length=40)\r\n      proxyTicket = models.CharField(max_length=70)\r\n  ```\r\n\r\n###urls.py###\r\n  ```python\r\n    #This URL validates the ticket returned after CAS login\r\n    (r'^CAS_serviceValidater', 'casclient.views.cas_validateTicket'),\r\n    #This URL is a dummy callback\r\n    (r'^CAS_proxyCallback', 'casclient.views.cas_proxyCallback'),\r\n    #This URL records Proxy IOU & ID\r\n    (r'^CAS_proxyUrl', 'casclient.views.cas_storeProxyIOU_ID'),\r\n  ```\r\n\r\n###views.py###\r\n  ```python\r\n   def get_cas_client():\r\n       \"\"\"\r\n       This is how you initialize a CAS Client\r\n       \"\"\"\r\n       return CASClient(settings.CAS_SERVER,\r\n               settings.SERVICE_URL,\r\n               proxy_url=settings.PROXY_URL,\r\n               proxy_callback=settings.PROXY_CALLBACK_URL,\r\n               self_signed_cert=settings.SELF_SIGNED_CERT)\r\n    def cas_validateTicket(request):\r\n        \"\"\"\r\n        Method expects 2 GET parameters: 'ticket' & 'sendback'\r\n        After a CAS Login:\r\n        Redirects the request based on the GET param 'ticket'\r\n        Unauthorized Users are redirected to '/' In the event of failure.\r\n        Authorized Users are redirected to the GET param 'sendback'\r\n        \"\"\"\r\n\r\n        redirect_logout_url = settings.REDIRECT_URL+\"/login/\"\r\n        no_user_url = settings.REDIRECT_URL + \"/no_user/\"\r\n        logger.debug('GET Variables:%s' % request.GET)\r\n        ticket = request.GET.get('ticket', None)\r\n        sendback = request.GET.get('sendback', None)\r\n\r\n        if not ticket:\r\n            logger.info(\"No Ticket received in GET string \"\r\n                        \"-- Logout user: %s\" % redirect_logout_url)\r\n            return HttpResponseRedirect(redirect_logout_url)\r\n\r\n        logger.debug(\"ServiceValidate endpoint includes a ticket.\"\r\n                     \" Ticket must now be validated with CAS\")\r\n\r\n        # ReturnLocation set, apply on successful authentication\r\n\r\n        caslib = get_cas_client()\r\n        caslib.service_url = _set_redirect_url(sendback, request)\r\n\r\n        cas_response = caslib.cas_serviceValidate(ticket)\r\n        if not cas_response.success:\r\n            logger.debug(\"CAS Server did NOT validate ticket:%s\"\r\n                         \" and included this response:%s\"\r\n                         % (ticket, cas_response.object))\r\n            return HttpResponseRedirect(redirect_logout_url)\r\n        if not cas_response.user:\r\n            logger.debug(\"User attribute missing from cas response!\"\r\n                         \"This may require a fix to caslib.py\")\r\n            return HttpResponseRedirect(redirect_logout_url)\r\n        if not cas_response.proxy_granting_ticket:\r\n            logger.error(\"\"\"Proxy Granting Ticket missing!\r\n                Possible Causes:\r\n                  * ServerName variable is wrong in /etc/apache2/apache2.conf\r\n                  * Proxy URL does not exist\r\n                  * Proxy URL is not a valid RSA-2/VeriSigned SSL certificate\r\n                  * /etc/host and hostname do not match machine.\"\"\")\r\n            return HttpResponseRedirect(redirect_logout_url)\r\n\r\n        #Implementation specific - Find matching ticket && user in Database\r\n        updated = updateUserProxy(user, pgtIou)\r\n        if not updated:\r\n            return HttpResponseRedirect(redirect_logout_url)\r\n        logger.info(\"Updated proxy for <%s> -- Auth success!\" % user)\r\n        logger.info(\"Create tokens, do implementation specific stuff\"\r\n                    \", return to: %s\" % return_to)\r\n        return HttpResponseRedirect(return_to)\r\n\r\n    def cas_storeProxyIOU_ID(request):\r\n        \"\"\"\r\n        Any request to the proxy url will contain the PROXY-TICKET IOU and ID\r\n        IOU and ID are mapped to a DB so they can be used later\r\n        \"\"\"\r\n        if \"pgtIou\" in request.GET and \"pgtId\" in request.GET:\r\n          proxy = UserProxy(proxyIOU=request.GET[\"pgtIou\"], proxyTicket=request.GET[\"pgtId\"])\r\n          proxy.save()\r\n        return HttpResponse(\"Received proxy request. Thank you.\")\r\n\r\n    def cas_proxyCallback(request):\r\n        \"\"\"\r\n        This is a placeholder for a proxyCallback service, needed for CAS authentication\r\n        \"\"\"\r\n        return HttpResponse(\"I am at a RSA-2 or VeriSigned SSL Cert. website, and therefore a valid proxy.\")\r\n\r\n    def login(request):\r\n        \"\"\"\r\n        CAS Login : Phase 1/3 Call CAS Login\r\n        \"\"\"\r\n        #Form Sets 'next' when user clicks login\r\n        if 'next' in request.POST:\r\n          url = CAS_SERVER+\"/cas/login?service=\"+\"https://my.djangoserver.org/CAS_serviceValidater?sendback=/application/\"\r\n          return HttpResponseRedirect(url)\r\n        #After CAS login, he will hit 'cas_getTicket'\r\n        else:\r\n          template = get_template('application/login.html')\r\n  ```\r\n\r\nGENERIC IMPLEMENTATION\r\n-------------\r\ncaslib.py can be used on any server, provided that the server has a method for storing and recalling users, IOUs, and IDs and includes the 3 Endpoints described below:\r\n\r\n_(USER,IOU,ID) Storage methods:_\r\n- Database:\r\n  All that is needed is one table to hold three string values:\r\n\r\n      caslib_userProxy\r\n      ----------------\r\n      * username\r\n      * proxyIOU\r\n      * proxyTicket\r\n      NOTE: Username is initially null, IOU and Ticket always stored @ cas_proxy_url BEFORE returning username to cas_service_url\r\n\r\n\r\n  Endpoints:\r\n  1. cas_proxy_url - Create a new entry in the Database (\"\",IOU,ID) where IOU and ID are in the GET request\r\n  2. cas_proxy_callback - a blank page, nothing is required here except that the page is valid.\r\n  3. cas_service_url - In addition to validating the ticket, lookup the IOU in DB (provided in cas_proxy_url) and record associated username to the database - (username, IOU, ID)\r\n\r\nOAUTH Authentication\r\n===================\r\n\r\nOAuth Authentication is very similar to CAS Authentication, the difference is in the values you request from the client/response objects.\r\n\r\n###settings.py###\r\n  ```python\r\n    ##These settings will be used often\r\n    CAS_SERVER = \"https://path.to_cas_server.org\"\r\n    OAUTH_CLIENT_KEY = \"cas_registered_client\"\r\n    OAUTH_CLIENT_SECRET = \"shh_its_a_secret\"\r\n    #This URL exists on YOUR server\r\n    OAUTH_CLIENT_CALLBACK = SERVER_URL + \"/oauth2.0/callbackAuthorize\"\r\n  ```\r\n###views.py###\r\n  ```python\r\n  def get_cas_oauth_client():\r\n      o_client = OAuthClient(settings.CAS_SERVER,\r\n              settings.OAUTH_CLIENT_CALLBACK,\r\n              settings.OAUTH_CLIENT_KEY,\r\n              settings.OAUTH_CLIENT_SECRET)\r\n      return o_client\r\n  def o_login_redirect(request):\r\n      oauth_client = get_cas_oauth_client()\r\n      url = oauth_client.authorize_url()\r\n      return HttpResponseRedirect(url)\r\n  def o_callback_authorize(request):\r\n      if 'code' not in request.GET:\r\n          logger.info(request.__dict__)\r\n          #TODO - Maybe: Redirect into a login\r\n          return HttpResponse(\"\")\r\n\r\n      oauth_client = get_cas_oauth_client()\r\n      oauth_code = request.GET['code']\r\n\r\n      #Exchange code for ticket\r\n      access_token, expiry_date = oauth_client.get_access_token(oauth_code)\r\n\r\n      if not access_token:\r\n          logger.info(\"The Code %s is invalid/expired. Attempting another login.\"\r\n                      % oauth_code)\r\n          return o_login_redirect(request)\r\n\r\n      #Exchange token for profile\r\n      user_profile = oauth_client.get_profile(access_token)\r\n\r\n      if not user_profile or \"id\" not in user_profile:\r\n          logger.error(\"AccessToken is producing an INVALID profile! \"\r\n                       \"Check the CAS server and caslib.py for more information.\")\r\n          #NOTE: Make sure this redirects the user OUT of the loop!\r\n          return login(request)\r\n\r\n      #ASSERT: A valid OAuth token gave us the Users Profile.\r\n      # Now create an AuthToken and return it\r\n      username = user_profile[\"id\"]\r\n      #Implementation specific.. create an API token and return\r\n      # it to the user...\r\n      return HttpResponseRedirect(\"my.app.com/application\")\r\n  ```\r\n\r\nSAML Authentication\r\n===================\r\n\r\n###settings.py###\r\n  ```python\r\n    ##These settings will be used often\r\n    CAS_SERVER = \"https://path.to_cas_server.org\"\r\n  ```\r\n###views.py###\r\n```python\r\ndef get_saml_client():\r\n    s_client = SAMLClient(settings.CAS_SERVER,\r\n            settings.SERVER_URL)\r\n    return s_client\r\n\r\ndef saml_validateTicket(request):\r\n    \"\"\"\r\n    Method expects 2 GET parameters: 'ticket' & 'sendback'\r\n    After a CAS Login:\r\n    Redirects the request based on the GET param 'ticket'\r\n    Unauthorized Users are redirected to '/' In the event of failure.\r\n    Authorized Users are redirected to the GET param 'sendback'\r\n    \"\"\"\r\n\r\n    redirect_logout_url = settings.REDIRECT_URL+\"/login/\"\r\n    no_user_url = settings.REDIRECT_URL + \"/no_user/\"\r\n    logger.debug('GET Variables:%s' % request.GET)\r\n    ticket = request.GET.get('ticket', None)\r\n    sendback = request.GET.get('sendback', None)\r\n\r\n    if not ticket:\r\n        logger.info(\"No Ticket received in GET string \"\r\n                    \"-- Logout user: %s\" % redirect_logout_url)\r\n        return HttpResponseRedirect(redirect_logout_url)\r\n\r\n    logger.debug(\"ServiceValidate endpoint includes a ticket.\"\r\n                 \" Ticket must now be validated with SAML\")\r\n\r\n    # ReturnLocation set, apply on successful authentication\r\n\r\n    saml_client = get_saml_client()\r\n    saml_response = saml_client.saml_serviceValidate(ticket)\r\n    if not saml_response.success:\r\n        logger.debug(\"CAS Server did NOT validate ticket:%s\"\r\n                     \" and included this response:%s\"\r\n                     % (ticket, saml_response.xml))\r\n        return HttpResponseRedirect(redirect_logout_url)\r\n\r\n    #Implementation specific... Create API token for\r\n    # saml_response.user\r\n    return HttpResponseRedirect(\"my.app.com/application\")\r\n```",
    "docs_url": null,
    "download_url": "",
    "downloads": {
      "last_day": 0,
      "last_month": 0,
      "last_week": 0
    },
    "home_page": "https://github.com/CyVerse/caslib.py",
    "keywords": "",
    "license": "",
    "maintainer": "",
    "maintainer_email": "",
    "name": "caslib.py",
    "platform": "UNKNOWN",
    "project_url": "https://pypi.org/project/caslib.py/",
    "release_url": "https://pypi.org/project/caslib.py/2.2.2/",
    "requires_python": null,
    "summary": "CAS Client library",
    "version": "2.2.2"
  },
  "releases": {
    "2.1.0": [
      {
        "comment_text": "",
        "digests": {
          "md5": "39aa54d2dd9cbf845ed04b50eb649177",
          "sha256": "e9b92a04ca0781421a84adfbc296f8b4500567f6a42eaf11a1bd9561930a9647"
        },
        "downloads": 2068,
        "filename": "caslib.py-2.1.0-py2-none-any.whl",
        "has_sig": true,
        "md5_digest": "39aa54d2dd9cbf845ed04b50eb649177",
        "packagetype": "bdist_wheel",
        "python_version": "py2",
        "size": 8094,
        "upload_time": "2014-09-19T22:55:57",
        "url": "https://files.pythonhosted.org/packages/71/1c/2b63f8b30e42fdd165d9e0409a97d375d6ae68e48b0807cc674e0a2f0fc0/caslib.py-2.1.0-py2-none-any.whl"
      },
      {
        "comment_text": "",
        "digests": {
          "md5": "abb56bc0c20deef5bb8950a28b500915",
          "sha256": "764ef1cb80190a31ff8063951cc6ee8a71ce18bfe30b1d70b7b318dcedce27d6"
        },
        "downloads": 1798,
        "filename": "caslib.py-2.1.0.tar.gz",
        "has_sig": true,
        "md5_digest": "abb56bc0c20deef5bb8950a28b500915",
        "packagetype": "sdist",
        "python_version": "source",
        "size": 11879,
        "upload_time": "2014-09-19T22:55:59",
        "url": "https://files.pythonhosted.org/packages/4f/17/10c7dd51caefe5199e5a619acecce80d09a7e03395fc26adaecf5598c719/caslib.py-2.1.0.tar.gz"
      }
    ],
    "2.2.0": [
      {
        "comment_text": "",
        "digests": {
          "md5": "6abd392c371ef03eb63dad1c844d2e25",
          "sha256": "526a5bd6929a3d43b6449d6a80db129ebe634f53763095df0df3c17b69fc5e2e"
        },
        "downloads": 1344,
        "filename": "caslib.py-2.2.0-py2-none-any.whl",
        "has_sig": true,
        "md5_digest": "6abd392c371ef03eb63dad1c844d2e25",
        "packagetype": "bdist_wheel",
        "python_version": "py2",
        "size": 8087,
        "upload_time": "2015-01-26T19:15:59",
        "url": "https://files.pythonhosted.org/packages/2f/6d/faed5a2fd2e1a80e3890139597f99091ce36ba3f487c4f17be50e625336a/caslib.py-2.2.0-py2-none-any.whl"
      },
      {
        "comment_text": "",
        "digests": {
          "md5": "ee7ec8d61d142f1a96919039403d0f27",
          "sha256": "0ea6cf382af1bd699fc9b4fd2c2c066474f7d3531bf6a605f2bd7bbbfde74461"
        },
        "downloads": 1304,
        "filename": "caslib.py-2.2.0.tar.gz",
        "has_sig": true,
        "md5_digest": "ee7ec8d61d142f1a96919039403d0f27",
        "packagetype": "sdist",
        "python_version": "source",
        "size": 11888,
        "upload_time": "2015-01-26T19:16:02",
        "url": "https://files.pythonhosted.org/packages/15/bc/c6d550950e49439a3bb2a0bfe8d31f58c5d31adfbdfd1d16978f2588397a/caslib.py-2.2.0.tar.gz"
      }
    ],
    "2.2.2": [
      {
        "comment_text": "",
        "digests": {
          "md5": "668f6724812746451169b338f5f4bacf",
          "sha256": "a9b9888f16262a84f51bbc437336b5eb8af4e9bdd24c19551785fbdd602c438e"
        },
        "downloads": 1174,
        "filename": "caslib.py-2.2.2-py2-none-any.whl",
        "has_sig": true,
        "md5_digest": "668f6724812746451169b338f5f4bacf",
        "packagetype": "bdist_wheel",
        "python_version": "py2",
        "size": 7961,
        "upload_time": "2015-08-27T15:51:11",
        "url": "https://files.pythonhosted.org/packages/9f/87/1af0f7e8d0a312b2f42a20ce76c043197a97cc197587c4a2d9da55a129de/caslib.py-2.2.2-py2-none-any.whl"
      },
      {
        "comment_text": "",
        "digests": {
          "md5": "15ce0fa05c53b6b41a275da0c6dfb05e",
          "sha256": "8323d78e0d5630ce7c84b0353f73d68ffe9353afbb289c56482ef2df9042ee3c"
        },
        "downloads": 787,
        "filename": "caslib.py-2.2.2.tar.gz",
        "has_sig": true,
        "md5_digest": "15ce0fa05c53b6b41a275da0c6dfb05e",
        "packagetype": "sdist",
        "python_version": "source",
        "size": 11755,
        "upload_time": "2015-08-27T15:51:14",
        "url": "https://files.pythonhosted.org/packages/9c/d8/363c744cd8967d5919665a0b992e1421f200092e8d21a17da74dfc02534b/caslib.py-2.2.2.tar.gz"
      }
    ]
  },
  "urls": [
    {
      "comment_text": "",
      "digests": {
        "md5": "668f6724812746451169b338f5f4bacf",
        "sha256": "a9b9888f16262a84f51bbc437336b5eb8af4e9bdd24c19551785fbdd602c438e"
      },
      "downloads": 1174,
      "filename": "caslib.py-2.2.2-py2-none-any.whl",
      "has_sig": true,
      "md5_digest": "668f6724812746451169b338f5f4bacf",
      "packagetype": "bdist_wheel",
      "python_version": "py2",
      "size": 7961,
      "upload_time": "2015-08-27T15:51:11",
      "url": "https://files.pythonhosted.org/packages/9f/87/1af0f7e8d0a312b2f42a20ce76c043197a97cc197587c4a2d9da55a129de/caslib.py-2.2.2-py2-none-any.whl"
    },
    {
      "comment_text": "",
      "digests": {
        "md5": "15ce0fa05c53b6b41a275da0c6dfb05e",
        "sha256": "8323d78e0d5630ce7c84b0353f73d68ffe9353afbb289c56482ef2df9042ee3c"
      },
      "downloads": 787,
      "filename": "caslib.py-2.2.2.tar.gz",
      "has_sig": true,
      "md5_digest": "15ce0fa05c53b6b41a275da0c6dfb05e",
      "packagetype": "sdist",
      "python_version": "source",
      "size": 11755,
      "upload_time": "2015-08-27T15:51:14",
      "url": "https://files.pythonhosted.org/packages/9c/d8/363c744cd8967d5919665a0b992e1421f200092e8d21a17da74dfc02534b/caslib.py-2.2.2.tar.gz"
    }
  ]
}